<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test CORS Avanc√© - SIGEC API</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        border-left: 4px solid #ccc;
      }
      .success {
        background-color: #d4edda;
        border-color: #28a745;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #17a2b8;
        color: #0c5460;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      .request-details {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        margin-top: 10px;
      }
      pre {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Test CORS Avanc√© - SIGEC API</h1>
      <p>
        Ce test v√©rifie la configuration CORS pour les requ√™tes vers
        <code>https://api.sigec.artbenshow.com</code>
      </p>

      <div class="info">
        <strong>Configuration actuelle :</strong>
        <ul>
          <li>API URL: <code>https://api.sigec.artbenshow.com</code></li>
          <li>
            Endpoints test√©s: <code>/register</code>, <code>/login</code>,
            <code>/health</code>
          </li>
          <li>Domaines autoris√©s: <code>*</code></li>
          <li>
            M√©thodes autoris√©es:
            <code>GET, POST, PUT, DELETE, OPTIONS, PATCH</code>
          </li>
        </ul>
      </div>
    </div>

    <div class="container">
      <h2>üß™ Tests de Requ√™tes</h2>
      <button onclick="testRegister()">Test /register</button>
      <button onclick="testLogin()">Test /login</button>
      <button onclick="testHealth()">Test /health</button>
      <button onclick="testPreflight()">Test OPTIONS (Preflight)</button>
      <button onclick="runAllTests()">üöÄ Lancer tous les tests</button>
      <button onclick="clearResults()">üóëÔ∏è Effacer les r√©sultats</button>
    </div>

    <div id="results-container"></div>

    <script>
      const API_BASE_URL = "https://api.sigec.artbenshow.com";
      let testResults = [];

      function addResult(title, status, message, details = null) {
        const resultDiv = document.createElement("div");
        resultDiv.className = `container test-result ${status}`;

        const timestamp = new Date().toLocaleTimeString();
        const statusIcon =
          status === "success" ? "‚úÖ" : status === "error" ? "‚ùå" : "‚ÑπÔ∏è";

        resultDiv.innerHTML = `
                <h3>${statusIcon} ${title} <small style="opacity: 0.7;">(${timestamp})</small></h3>
                <p>${message}</p>
                ${
                  details
                    ? `<div class="request-details"><strong>D√©tails:</strong><br>${details}</div>`
                    : ""
                }
            `;

        document.getElementById("results-container").prepend(resultDiv);
        testResults.push({ title, status, message, timestamp, details });
      }

      function clearResults() {
        document.getElementById("results-container").innerHTML = "";
        testResults = [];
      }

      async function makeRequest(endpoint, method = "POST", data = null) {
        const url = `${API_BASE_URL}${endpoint}`;
        const options = {
          method: method,
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest",
          },
        };

        if (
          data &&
          (method === "POST" || method === "PUT" || method === "PATCH")
        ) {
          options.body = JSON.stringify(data);
        }

        try {
          const response = await fetch(url, options);
          const responseData = await response.text();
          let parsedData;

          try {
            parsedData = JSON.parse(responseData);
          } catch (e) {
            parsedData = responseData;
          }

          return {
            success: response.ok,
            status: response.status,
            statusText: response.statusText,
            headers: Object.fromEntries(response.headers.entries()),
            data: parsedData,
          };
        } catch (error) {
          return {
            success: false,
            error: error.message,
            type: error.name,
          };
        }
      }

      async function testRegister() {
        addResult(
          "Test /register",
          "info",
          "Envoi de la requ√™te d'enregistrement..."
        );

        const result = await makeRequest("/register", "POST", {
          name: "Test User",
          email: `test_${Date.now()}@example.com`,
          password: "testpassword123",
          password_confirmation: "testpassword123",
        });

        if (result.success) {
          addResult(
            "Test /register",
            "success",
            `Requ√™te r√©ussie! Status: ${result.status}`,
            `R√©ponse: ${JSON.stringify(result.data, null, 2)}`
          );
        } else {
          addResult(
            "Test /register",
            "error",
            `√âchec de la requ√™te: ${result.error || "Erreur inconnue"}`,
            `Type: ${result.type || "N/A"}`
          );
        }
      }

      async function testLogin() {
        addResult("Test /login", "info", "Envoi de la requ√™te de connexion...");

        const result = await makeRequest("/login", "POST", {
          email: "test@example.com",
          password: "wrongpassword",
        });

        if (result.success) {
          addResult(
            "Test /login",
            "success",
            `Requ√™te r√©ussie! Status: ${result.status}`,
            `R√©ponse: ${JSON.stringify(result.data, null, 2)}`
          );
        } else {
          // 401 est attendu avec de mauvais identifiants
          if (result.status === 401) {
            addResult(
              "Test /login",
              "success",
              `CORS fonctionne! Status 401 attendu pour mauvais identifiants`,
              `R√©ponse: ${JSON.stringify(result.data, null, 2)}`
            );
          } else {
            addResult(
              "Test /login",
              "error",
              `√âchec inattendu: ${result.status} - ${result.statusText}`,
              `R√©ponse: ${JSON.stringify(result.data, null, 2)}`
            );
          }
        }
      }

      async function testHealth() {
        addResult(
          "Test /health",
          "info",
          "Envoi de la requ√™te health check..."
        );

        const result = await makeRequest("/health", "GET");

        if (result.success) {
          addResult(
            "Test /health",
            "success",
            `Health check r√©ussi! Status: ${result.status}`,
            `R√©ponse: ${JSON.stringify(result.data, null, 2)}`
          );
        } else {
          addResult(
            "Test /health",
            "error",
            `√âchec du health check: ${result.error || "Erreur inconnue"}`,
            `Status: ${result.status || "N/A"}, Type: ${result.type || "N/A"}`
          );
        }
      }

      async function testPreflight() {
        addResult(
          "Test OPTIONS (Preflight)",
          "info",
          "Envoi de la requ√™te OPTIONS..."
        );

        const result = await makeRequest("/register", "OPTIONS");

        if (result.success) {
          addResult(
            "Test OPTIONS (Preflight)",
            "success",
            `Preflight r√©ussi! Status: ${result.status}`,
            `Headers de r√©ponse: ${JSON.stringify(result.headers, null, 2)}`
          );
        } else {
          addResult(
            "Test OPTIONS (Preflight)",
            "error",
            `√âchec du preflight: ${result.error || "Erreur inconnue"}`,
            `Status: ${result.status || "N/A"}`
          );
        }
      }

      async function runAllTests() {
        clearResults();
        addResult(
          "Tests automatis√©s",
          "info",
          "D√©marrage de tous les tests CORS..."
        );

        await testHealth();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testPreflight();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testRegister();
        await new Promise((resolve) => setTimeout(resolve, 500));

        await testLogin();

        addResult(
          "Tests automatis√©s",
          "success",
          "Tous les tests sont termin√©s!"
        );
      }

      // Test automatique au chargement de la page
      window.addEventListener("load", function () {
        setTimeout(() => {
          addResult(
            "Page charg√©e",
            "info",
            "Tests CORS pr√™ts. Cliquez sur les boutons pour tester."
          );
        }, 500);
      });
    </script>
  </body>
</html>
